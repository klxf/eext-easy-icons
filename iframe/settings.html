<!doctype html>
<html lang="zh">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>扩展设置</title>
	<link rel="stylesheet" href="/iframe/css/index.css" />
	<script src="/iframe/js/jszip.min.js"></script>
	<style>
		::-webkit-scrollbar { height: 0.25rem; width: 0.25rem; }
		::-webkit-scrollbar-thumb { background: rgba(0, 0, 0, 0.2); }
		*:focus { outline: none; }

		.url-input {
			flex: 1; border: 1px solid #e5e7eb; padding: 6px 10px;
			border-radius: 6px; font-size: 13px; transition: border-color 0.2s;
		}
		.url-input:focus { border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1); }

		.btn-action { padding: 4px 10px; border-radius: 6px; font-size: 12px; cursor: pointer; border: none; transition: all 0.2s; }
		.btn-add { background-color: #3b82f6; color: white; }
		.btn-add:hover { background-color: #2563eb; }
		.btn-public { background-color: #10b981; color: white; margin-right: 4px; }
		.btn-public:hover { background-color: #059669; }
		.btn-delete { color: #ef4444; border: 1px solid #fecaca; background: white; }
		.btn-delete:hover { background-color: #fef2f2; }

		.zip-card {
			display: flex; align-items: center; justify-content: space-between;
			padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px; background: #fff;
		}

		/* 模态框样式 */
		#modal-overlay {
			position: fixed; inset: 0; background: rgba(0,0,0,0.5);
			display: none; justify-content: center; align-items: center; z-index: 100;
		}
		.modal-content {
			background: white; width: 450px; max-height: 80vh; border-radius: 12px;
			display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
		}
		.repo-item {
			padding: 12px; border-bottom: 1px solid #f3f4f6; transition: background 0.2s;
		}
		.repo-item:hover { background-color: #f9fafb; }
	</style>
</head>
<body class="bg-gray-100">
<div class="bg-white p-6 rounded-xl shadow-sm w-[400px] mx-auto">
	<div class="flex items-center justify-between mb-6">
		<h2 class="text-lg font-semibold text-gray-800">图标库设置</h2>
		<div>
			<button id="open-public-btn" class="btn-action btn-public">公开库</button>
			<button id="add-url-btn" class="btn-action btn-add">+ 添加</button>
		</div>
	</div>
	<div id="url-list-container" class="space-y-3"></div>
	<p class="text-[11px] text-gray-400 mt-6 border-t pt-4">注意：远程库需要指向有效的 JSON 文件地址</p>

	<div class="flex items-center justify-between mt-8 mb-4">
		<h2 class="text-lg font-semibold text-gray-800">离线图标包</h2>
		<div>
			<button id="add-zip-btn" class="btn-action btn-add">+ 添加 .zip</button>
		</div>
	</div>
	<div id="zip-list-container" class="space-y-3"></div>
</div>

<div id="modal-overlay">
	<div class="modal-content">
		<div class="p-4 border-bottom flex justify-between items-center bg-gray-50">
			<span class="font-bold text-gray-700">选择公开图标库</span>
			<button id="close-modal" class="text-gray-400 hover:text-gray-600 text-xl">&times;</button>
		</div>
		<div id="modal-list" class="overflow-y-auto p-2 flex-1">
			<div class="text-center py-10 text-gray-400">加载中...</div>
		</div>
	</div>
</div>

<script>
	const CONFIG_KEY = 'settings-repo-urls';
	const ZIP_LIST_KEY = 'settings-zip-list';
	const ZIP_FILE_PREFIX = 'offline-zip-';
	const OFFICIAL_LIST_URL = 'https://atta.dragon.edu.kg/icon-repo/list.json';

	const container = document.getElementById('url-list-container');
	const zipContainer = document.getElementById('zip-list-container');
	const modal = document.getElementById('modal-overlay');
	const modalList = document.getElementById('modal-list');

	async function init() {
		const urls = (await eda.sys_Storage.getExtensionUserConfig(CONFIG_KEY)) || [];
		urls.length === 0 ? renderEmpty(container) : urls.forEach(url => addUrlRow(url));

		renderZipList();
	}

	function renderEmpty(el) {
		el.innerHTML = '<div class="text-center py-4 text-gray-400 text-sm">暂无配置</div>';
	}

	function addUrlRow(value = '') {
		if (container.querySelector('.text-center')) container.innerHTML = '';
		const row = document.createElement('div');
		row.className = 'flex items-center gap-2 group';
		row.innerHTML = `
					<input type="text" class="url-input" placeholder="https://..." value="${value}">
					<button class="btn-action btn-delete">删除</button>
				`;
		row.querySelector('input').addEventListener('change', () => saveAllUrls());
		row.querySelector('.btn-delete').addEventListener('click', () => {
			row.remove();
			if (container.children.length === 0) renderEmpty(container);
			saveAllUrls();
		});
		container.appendChild(row);
	}

	function saveAllUrls() {
		const urls = Array.from(container.querySelectorAll('.url-input'))
			.map(i => i.value.trim()).filter(v => v !== '');
		eda.sys_Storage.setExtensionUserConfig(CONFIG_KEY, urls).then(() => {
			eda.sys_Message.showToastMessage('远程配置已更新', ESYS_ToastMessageType.SUCCESS);
		});
	}

	async function renderZipList() {
		const zips = (await eda.sys_Storage.getExtensionUserConfig(ZIP_LIST_KEY)) || [];
		zipContainer.innerHTML = '';

		if (zips.length === 0) {
			renderEmpty(zipContainer);
			return;
		}

		zips.forEach(item => {
			const div = document.createElement('div');
			div.className = 'zip-card';
			div.innerHTML = `
				<div class="flex flex-col">
					<span class="text-sm font-medium text-gray-700">${item.displayName}</span>
					<span class="text-[10px] text-gray-400">v${item.version} | ${item.uuid.slice(0,8)}...</span>
				</div>
				<button class="btn-action btn-delete" data-uuid="${item.uuid}">删除</button>
			`;
			div.querySelector('.btn-delete').onclick = () => deleteZip(item.uuid);
			zipContainer.appendChild(div);
		});
	}

	async function handleAddZip() {
		try {
			const res = await eda.sys_FileSystem.openReadFileDialog('.zip');

			if (!res) return;

			const zipFile = Array.isArray(res) ? res[0] : res;

			if (!zipFile) {
				throw new Error('未能获取到有效的文件对象');
			}

			eda.sys_Message.showToastMessage('正在解析图标包...', ESYS_ToastMessageType.INFO);

			const arrayBuffer = await new Promise((resolve, reject) => {
				const reader = new FileReader();
				reader.onload = () => resolve(reader.result);
				reader.onerror = () => reject(new Error('文件读取失败'));
				reader.readAsArrayBuffer(zipFile);
			});

			const zip = await JSZip.loadAsync(arrayBuffer);
			const jsonFile = zip.file("repo.json");

			if (!jsonFile) {
				throw new Error('未在压缩包根目录找到 repo.json');
			}

			const jsonContent = await jsonFile.async("string");
			const repoData = JSON.parse(jsonContent);

			if (!repoData.uuid) throw new Error('repo.json 缺少必要字段: uuid');

			await eda.sys_Storage.setExtensionUserConfig(ZIP_FILE_PREFIX + repoData.uuid, zipFile);

			const zips = (await eda.sys_Storage.getExtensionUserConfig(ZIP_LIST_KEY)) || [];
			const index = zips.findIndex(z => z.uuid === repoData.uuid);
			const meta = {
				uuid: repoData.uuid,
				displayName: repoData.displayName || repoData.name,
				version: repoData.version,
				importTime: Date.now()
			};

			if (index > -1) zips[index] = meta;
			else zips.push(meta);

			await eda.sys_Storage.setExtensionUserConfig(ZIP_LIST_KEY, zips);

			eda.sys_Message.showToastMessage('离线包导入成功', ESYS_ToastMessageType.SUCCESS);
			renderZipList();
		} catch (err) {
			console.error('导入插件包出错:', err);
			eda.sys_Message.showToastMessage('导入失败: ' + err.message, ESYS_ToastMessageType.ERROR);
		}
	}

	async function deleteZip(uuid) {
		if (!confirm('确定要删除这个离线图标包吗？')) return;

		await eda.sys_Storage.setExtensionUserConfig(ZIP_FILE_PREFIX + uuid, null);

		let zips = (await eda.sys_Storage.getExtensionUserConfig(ZIP_LIST_KEY)) || [];
		zips = zips.filter(z => z.uuid !== uuid);
		await eda.sys_Storage.setExtensionUserConfig(ZIP_LIST_KEY, zips);

		renderZipList();
		eda.sys_Message.showToastMessage('已删除离线包', ESYS_ToastMessageType.SUCCESS);
	}

	document.getElementById('open-public-btn').onclick = async () => {
		modal.style.display = 'flex';
		modalList.innerHTML = '<div class="text-center py-10 text-gray-400">正在获取库列表...</div>';
		try {
			const res = await fetch(OFFICIAL_LIST_URL);
			const data = await res.json();
			renderModalList(data.repository);
		} catch (e) {
			modalList.innerHTML = '<div class="text-center py-10 text-red-400">加载失败，请检查网络</div>';
		}
	};

	function renderModalList(repos) {
		modalList.innerHTML = '';
		repos.forEach(repo => {
			const div = document.createElement('div');
			div.className = 'repo-item';
			div.innerHTML = `
						<div class="flex justify-between items-start mb-1">
							<span class="font-bold text-blue-600">${repo.displayName} <span class="text-[10px] bg-blue-100 px-1 rounded">v${repo.version}</span></span>
							<button class="btn-action btn-add btn-sm py-1 select-repo-btn" data-url="${repo.json}">添加</button>
						</div>
						<div class="text-[11px] text-gray-500 mb-1">作者: ${repo.publisher}</div>
						<div class="text-[12px] text-gray-600 leading-tight mb-1">${repo.description}</div>
						<div class="text-[11px] text-gray-600 leading-tight">主页：<a class="text-blue-600 hover:underline" href="${repo.homepage}" target="_blank">${repo.homepage}</a></div>
					`;
			div.querySelector('.select-repo-btn').onclick = (e) => {
				addUrlRow(e.target.dataset.url);
				saveAllUrls();
				modal.style.display = 'none';
			};
			modalList.appendChild(div);
		});
	}

	document.getElementById('close-modal').onclick = () => modal.style.display = 'none';
	modal.onclick = (e) => { if(e.target === modal) modal.style.display = 'none'; };

	document.getElementById('add-url-btn').onclick = () => addUrlRow();
	document.getElementById('add-zip-btn').onclick = handleAddZip;

	init();
</script>
</body>
</html>
